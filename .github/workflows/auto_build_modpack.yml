name: Create Modpack Release

on: workflow_dispatch

jobs:
    create-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2
                  ref: main
                  path: main_repo

            - name: Set up environment and determine version
              id: setup
              run: |
                  cd main_repo

                  CHANGELOG_PATH="./CHANGELOG.md"
                  if [ ! -f "$CHANGELOG_PATH" ]; then
                      echo "Error: $CHANGELOG_PATH not found in main_repo."
                      exit 1
                  fi

                  VERSION_LINE=$(grep -oP '^## .*$' "$CHANGELOG_PATH" | head -n1 | sed 's/^## //')

                  if [ -z "$VERSION_LINE" ]; then
                      echo "Error: Failed to extract version line from $CHANGELOG_PATH."
                      exit 1
                  fi

                  PURE_VERSION=$(echo "$VERSION_LINE" | grep -oP 'v\K[0-9]+(\.[0-9]+)*')

                  if [ -z "$PURE_VERSION" ]; then
                      echo "Error: Failed to extract pure version number from version line: $VERSION_LINE"
                      exit 1
                  fi

                  # Remove the trailing 'v<version>' from the title to get the prefix (trim spaces)
                  VERSION_PREFIX=$(echo "$VERSION_LINE" | sed -E "s/[[:space:]]*v${PURE_VERSION}[[:space:]]*$//" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

                  if [ -n "$VERSION_PREFIX" ]; then
                      FULL_VERSION_NAME="${VERSION_PREFIX} v${PURE_VERSION}"
                  else
                      FULL_VERSION_NAME="v${PURE_VERSION}"
                  fi

                  if [ "$VERSION_PREFIX" = "Release" ]; then
                      PRERELEASE_FLAG="false"
                  else
                      PRERELEASE_FLAG="true"
                  fi

                  ZIP_NAME="Return to the Age of Technology-${FULL_VERSION_NAME}.zip"

                  echo "Extracted pure version: $PURE_VERSION"
                  echo "Extracted full version: $FULL_VERSION_NAME"
                  echo "Prerelease flag: $PRERELEASE_FLAG"
                  echo "ZIP filename will be: $ZIP_NAME"
                  echo "PURE_VERSION=$PURE_VERSION" >> $GITHUB_OUTPUT
                  echo "FULL_VERSION_NAME=$FULL_VERSION_NAME" >> $GITHUB_OUTPUT
                  echo "PRERELEASE_FLAG=$PRERELEASE_FLAG" >> $GITHUB_OUTPUT

            - name: Update manifest.json version
              run: |
                  cd main_repo
                  sed -i '/"name": *"Return to the Age of Technology",/!b;n;s/"version": *"[^"]*"/"version": "'"${{ steps.setup.outputs.FULL_VERSION_NAME }}"'"/' manifest.json
                  echo "Updated manifest.json with version ${{ steps.setup.outputs.FULL_VERSION_NAME }}"

            - name: Create and package modpack
              id: package
              run: |
                  cd main_repo
                  mkdir -p overrides
                  cp -r config defaultconfigs hotai kubejs ldlib overrides/
                  VERSION_NAME="${{ steps.setup.outputs.FULL_VERSION_NAME }}"
                  FILE_NAME="Return to the Age of Technology-${VERSION_NAME}.zip"
                  zip -r "../${FILE_NAME}" overrides manifest.json modlist.html
                  ls -lh "../${FILE_NAME}"
                  echo "ZIPFILE=${FILE_NAME}" >> $GITHUB_OUTPUT

            - name: Extract CHANGELOG for current version
              run: |
                  cd main_repo
                  sed -n "/^## .*v${{ steps.setup.outputs.PURE_VERSION }}/,/^## /p" CHANGELOG.md | sed '$d' > ../extracted_changelog.txt

            - name: Create GitHub Release and Upload Asset
              uses: softprops/action-gh-release@v3
              with:
                  tag_name: 'v${{ steps.setup.outputs.PURE_VERSION }}'
                  name: 'R2AoT ${{ steps.setup.outputs.FULL_VERSION_NAME }}'
                  body_path: extracted_changelog.txt
                  draft: false
                  prerelease: ${{ steps.setup.outputs.PRERELEASE_FLAG }}
                  files: './${{ steps.package.outputs.ZIPFILE }}'
                  align-asset-name: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
